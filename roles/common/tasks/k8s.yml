- name: Install k8s repository key
  ansible.builtin.apt_key:
    url: https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key
    keyring: "{{ common_k8s_keyring_path }}"
    state: present
  become: true

- name: Install k8s repository
  ansible.builtin.apt_repository:
    repo: deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /
    state: present
    update_cache: true
    filename: kubernetes
  become: true

- name: Install k8s packages
  ansible.builtin.apt:
    pkg:
      - kubelet
      - kubeadm
      - kubectl
    state: present
  become: true
  register: install_k8s_packages

- name: Mark hold k8s packages
  ansible.builtin.command:
    cmd: apt-mark hold kubelet kubeadm kubectl
  become: true
  when: install_k8s_packages is changed

- name: Bootstrap controlplane
  ansible.builtin.command:
    cmd: "kubeadm init --control-plane-endpoint=cluster-endpoint --pod-network-cidr='{{common_pod_network_cidr}}' --service-cidr='{{common_service_cidr}}'"
    creates: /etc/kubernetes/kubelet.conf
  become: true

- name: Create token
  ansible.builtin.command:
    cmd: "kubeadm token create"
  become: true
  register: kubeadm_join_token

- name: Get CA certificate hash
  community.crypto.x509_certificate_info:
    path: /etc/kubernetes/pki/ca.crt
  register: kubeadm_join_ca_hash

- name: Fetch join command
  local_action:
    module: ansible.builtin.copy
    content: 'kubeadm join cluster-endpoint:6443 --token {{ kubeadm_join_token.stdout }} --discovery-token-ca-cert-hash sha256:{{ kubeadm_join_ca_hash.public_key_fingerprints.sha256 | replace(":","") }}'
    dest: ./.credentials/join_command
    force: false # avoid copying the file if it already exists
  run_once: true

- name: Create .kube directory
  ansible.builtin.file:
    path: /home/ubuntu/.kube
    mode: '0700'
    owner: ubuntu
    group: ubuntu
    state: directory

- name: Copy kubeconfig to ubuntu user
  ansible.builtin.copy:
    dest: /home/ubuntu/.kube/config
    src: /etc/kubernetes/admin.conf
    mode: preserve
    owner: ubuntu
    group: ubuntu
    remote_src: true
  become: true

- name: Install Kubernetes Network add-on
  ansible.builtin.command:
    cmd: "kubectl apply -f {{network_addon_manifest}}"
